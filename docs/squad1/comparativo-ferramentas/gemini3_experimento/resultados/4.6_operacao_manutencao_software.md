# 4.6 Opera√ß√£o e Manuten√ß√£o de Software

## Prompt

```markdown
Atue como um Engenheiro DevOps / SRE (Site Reliability Engineer).

Precisamos preparar o `AlertService` (Java/Spring Boot) para produ√ß√£o.

1.  **CI/CD:** Crie um arquivo de workflow do **GitHub Actions** (`.github/workflows/pipeline.yml`) que realize as seguintes etapas a cada push na branch `main`: checkout, setup do Java, testes unit√°rios, build da imagem Docker e push para um registry.
2.  **Automa√ß√£o:** Escreva um `Dockerfile` otimizado para produ√ß√£o utilizando **Multi-stage builds** para separar a fase de compila√ß√£o da execu√ß√£o. Inclua tamb√©m um script ou instru√ß√£o para garantir que o container n√£o rode como root.
3.  **Monitoramento:** Quais m√©tricas (RED Method) voc√™ recomenda monitorar? Como expor m√©tricas customizadas (ex: contador de alertas duplicados) para o Prometheus usando Spring Boot Actuator?
4.  **Documenta√ß√£o T√©cnica Automatizada:** Gere um arquivo `README.md` completo para este reposit√≥rio, contendo: instru√ß√µes de "Como Rodar" (local e Docker), descri√ß√£o das vari√°veis de ambiente necess√°rias e exemplos de chamadas `curl` para os endpoints.
```

## Resposta Gerada

Aqui est√£o os artefatos e recomenda√ß√µes para preparar o `AlertService` para produ√ß√£o, seguindo as melhores pr√°ticas de DevOps e SRE.

### 1. CI/CD: GitHub Actions Workflow

Arquivo: `.github/workflows/pipeline.yml`

Este workflow realiza o build, testes e push da imagem Docker para o GitHub Container Registry (ghcr.io) a cada push na branch `main`.

```yaml
name: Java CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Run Unit Tests
      run: mvn test

    - name: Build with Maven
      run: mvn package -DskipTests

    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=sha,format=long
          type=ref,event=branch
          latest

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
```

### 2. Automa√ß√£o: Dockerfile Otimizado

Arquivo: `Dockerfile`

Utiliza multi-stage builds para manter a imagem final leve (usando JRE alpine ou slim) e cria um usu√°rio n√£o-root para seguran√ßa.

```dockerfile
# Stage 1: Build
FROM maven:3.9-eclipse-temurin-17-alpine AS builder
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

# Stage 2: Runtime
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# Cria√ß√£o de usu√°rio n√£o-root para seguran√ßa
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# Copia apenas o artefato necess√°rio do est√°gio de build
COPY --from=builder /app/target/*.jar app.jar

# Define o usu√°rio para execu√ß√£o
USER appuser

# Expose da porta padr√£o do Spring Boot
EXPOSE 8080

# Healthcheck b√°sico
HEALTHCHECK --interval=30s --timeout=3s \
  CMD wget -q --spider http://localhost:8080/actuator/health || exit 1

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 3. Monitoramento (RED Method & Spring Boot Actuator)

#### M√©tricas RED Method Recomendadas

O m√©todo RED foca na experi√™ncia do usu√°rio final e na confiabilidade do servi√ßo.

1.  **Rate (Taxa):** O n√∫mero de requisi√ß√µes por segundo que o servi√ßo est√° recebendo.
    *   *M√©trica:* `http_server_requests_seconds_count` (filtrado por endpoint).
2.  **Errors (Erros):** O n√∫mero de requisi√ß√µes que falharam.
    *   *M√©trica:* `http_server_requests_seconds_count` onde `status` come√ßa com 5xx (erros de servidor) ou 4xx (erros de cliente, se relevante).
3.  **Duration (Dura√ß√£o):** Quanto tempo as requisi√ß√µes levam (lat√™ncia).
    *   *M√©trica:* `http_server_requests_seconds_sum` / `http_server_requests_seconds_count` (para m√©dia) ou histogramas como `http_server_requests_seconds_bucket` para calcular percentis (P95, P99).

#### Expondo M√©tricas Customizadas (Contador de Alertas Duplicados)

Para expor m√©tricas customizadas no Prometheus usando Spring Boot Actuator, utilizamos o `MeterRegistry`.

**Exemplo de Implementa√ß√£o no Servi√ßo:**

```java
import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.stereotype.Service;

@Service
public class AlertProcessingService {

    private final Counter duplicateAlertsCounter;

    public AlertProcessingService(MeterRegistry registry) {
        // Inicializa o contador com nome e tags opcionais
        this.duplicateAlertsCounter = Counter.builder("alert.duplicate.count")
                .description("Number of duplicate alerts detected")
                .tag("service", "AlertService")
                .register(registry);
    }

    public void processAlert(Alert alert) {
        if (isDuplicate(alert)) {
            // Incrementa o contador
            duplicateAlertsCounter.increment();
            return;
        }
        // L√≥gica normal de processamento...
    }

    private boolean isDuplicate(Alert alert) {
        // L√≥gica de verifica√ß√£o de duplicidade
        return false; 
    }
}
```

**Configura√ß√£o no `application.properties` para expor ao Prometheus:**

```properties
management.endpoints.web.exposure.include=health,info,prometheus
management.endpoint.prometheus.enabled=true
management.metrics.export.prometheus.enabled=true
```

Isso disponibilizar√° as m√©tricas no endpoint `/actuator/prometheus`.

### 4. Documenta√ß√£o T√©cnica Automatizada: README.md

Arquivo: `README.md`

```markdown
# AlertService

Servi√ßo respons√°vel pelo recebimento, processamento e envio de alertas do sistema de monitoramento clim√°tico.

## üöÄ Como Rodar

### Pr√©-requisitos
- Java 17+
- Maven 3.8+
- Docker (opcional)

### Execu√ß√£o Local

1. Clone o reposit√≥rio:
   ```bash
   git clone https://github.com/seu-org/alert-service.git
   cd alert-service
   ```

2. Compile e execute com Maven:
   ```bash
   mvn spring-boot:run
   ```

O servi√ßo estar√° dispon√≠vel em `http://localhost:8080`.

### Execu√ß√£o com Docker

1. Construa a imagem:
   ```bash
   docker build -t alert-service .
   ```

2. Execute o container:
   ```bash
   docker run -p 8080:8080 --env-file .env alert-service
   ```

## üîß Vari√°veis de Ambiente

As seguintes vari√°veis de ambiente s√£o necess√°rias para a configura√ß√£o do servi√ßo:

| Vari√°vel | Descri√ß√£o | Valor Padr√£o / Exemplo |
|----------|-----------|------------------------|
| `SERVER_PORT` | Porta do servidor | `8080` |
| `DB_URL` | URL de conex√£o JDBC | `jdbc:postgresql://localhost:5432/alerts` |
| `DB_USER` | Usu√°rio do banco de dados | `postgres` |
| `DB_PASSWORD` | Senha do banco de dados | `secret` |
| `KAFKA_BROKERS` | Lista de brokers Kafka | `localhost:9092` |

## üì° Endpoints da API

### Criar um Alerta

Envia um novo alerta para processamento.

**Request:**

```bash
curl -X POST http://localhost:8080/api/alerts \
  -H "Content-Type: application/json" \
  -d '{
    "sensorId": "S-123",
    "type": "TEMPERATURE_HIGH",
    "value": 42.5,
    "timestamp": "2023-10-27T10:00:00Z"
  }'
```

**Response (201 Created):**

```json
{
  "id": "a1b2c3d4",
  "status": "RECEIVED"
}
```

### Listar Alertas

Retorna uma lista paginada de alertas.

**Request:**

```bash
curl -X GET "http://localhost:8080/api/alerts?page=0&size=10"
```

### Health Check

Verifica a sa√∫de da aplica√ß√£o (Actuator).

**Request:**

```bash
curl http://localhost:8080/actuator/health
```
```
